## 1 Introduction

This is an Android demo app to show how to integrate the output YoloX models by XGen into an android app.

## 2 Integration of XGen output into an app

Readers can see `app/src/main/cpp/inference_api.cc` to see how the output of XGen is used in an app for AI. This part gives the explanation.

#### 2.1 Import XGen SDK

Put '**xgen.h**', '**{model name}.data**', '**{model name}.pb**', '**libxgen.so**' into the corresponding directory of the project, and then modify **CMakeLists.txt** script. The **{model name}.data** and **{model name}.pb** are the model files generated by XGen toolchain.

#### 2.2 Initialize XGen

Call the _XGenInitWithFiles_ method to initialize XGen.

#### 2.3 Run XGen

First call the _XGenCopyBufferToTensor_ method to pass the preprocessed data into XGen runtime.

Then call the _XGenRun_ method to let XGen runtime call the AI model to conduct an inference.

And finally call the _XGenCopyTensorToBuffer_ method to copy the result into a buffer.

```c
    jobjectArray RunInference(JNIEnv *env, const jobjectArray input_data) {
        size_t input_tensor_num = XGenGetNumInputTensors(h);
        for (int i = 0; i < input_tensor_num; ++i) {
            auto array = (jfloatArray) env->GetObjectArrayElement(input_data, i);
            jfloat *array_data = env->GetFloatArrayElements(array, JNI_FALSE);
            XGenTensor *input_tensor = XGenGetInputTensor(h, i);
            size_t input_size_in_bytes = XGenGetTensorSizeInBytes(input_tensor);
            size_t input_size = input_size_in_bytes / sizeof(float);
            LOGI("tensor_index:%d input_size:%zu", i, input_size);
            auto buffer = std::shared_ptr<float>(new float[input_size], std::default_delete<float[]>());
            for (int j = 0; j < input_size; ++j) {
                buffer.get()[j] = array_data[j];
            }
            XGenCopyBufferToTensor(input_tensor, buffer.get(), input_size_in_bytes);
        }

        if (XGenRun(h) != XGenOk) {
            LOGI("FATAL ERROR: XGen inference failed.");
            return nullptr;
        }

        size_t output_tensor_num = XGenGetNumOutputTensors(h);
        jclass floatArrayCls = env->FindClass("[F");
        jobjectArray jReturnData = env->NewObjectArray(output_tensor_num, floatArrayCls, nullptr);
        for (int i = 0; i < output_tensor_num; ++i) {
            XGenTensor *output_tensor = XGenGetOutputTensor(h, i);
            size_t output_size_in_bytes = XGenGetTensorSizeInBytes(output_tensor);
            size_t output_size = output_size_in_bytes / sizeof(float);
            auto output_data = std::shared_ptr<float>(new float[output_size], std::default_delete<float[]>());
            XGenCopyTensorToBuffer(output_tensor, output_data.get(), output_size_in_bytes);
            jfloatArray jOutputData = env->NewFloatArray(output_size);
            env->SetFloatArrayRegion(jOutputData, 0, (jsize) output_size, output_data.get());
            env->SetObjectArrayElement(jReturnData, i, jOutputData);
        }
        return jReturnData;
    }
```

#### 2.6 Performance comparison

Faster and smaller model files with almost identical accuracy.

| Model                       | Terminal Latency (ms) | Demo FPS | Size (MB) |
|-----------------------------| --------------------- | -------- | --------- |
| Original_YOLOX(ONNX, 4 cls) | 423                   | 2        | 28.0      |
| XGen_YOLOX(Large, 4 cls)    | 86                    | 12       | 14.1      |
| XGen_YOLOX(Small, 4 cls)    | 40                    | 25       | 2.99      |

## 3 Copyright

© 2022 CoCoPIE Inc. All Rights Reserved.

CoCoPIE Inc., its logo and certain names, product and service names reference herein may be registered trademarks, trademarks, trade names or service marks of CoCoPIE Inc. in certain jurisdictions.

The material contained herein is proprietary, privileged and confidential and owned by CoCoPIE Inc. or its third-party licensors. The information herein is provided only to be person or entity to which it is addressed, for its own use and evaluation; therefore, no disclosure of the content of this manual will be made to any third parities without specific written permission from CoCoPIE Inc.. The content herein is subject to change without further notice. Limitation of Liability – CoCoPIE Inc. shall not be liable.

All other trademarks are the property of their respective owners. Other company and brand products and service names are trademarks or registered trademarks of their respective holders.

Limitation of Liability

CoCoPIE Inc. shall not be liable.
